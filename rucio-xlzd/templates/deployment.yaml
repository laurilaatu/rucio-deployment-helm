apiVersion: apps/v1
kind: Deployment
metadata:
  name: rucio-server
spec:
  replicas: {{ .Values.rucio.server.replicas }}
  selector:
    matchLabels:
      app: rucio-server
  template:
    metadata:
      labels:
        app: rucio-server
    spec:
      volumes:
      - name: grid-certificates
        hostPath:
          path: /etc/grid-security  # Ensure this path exists on the node
      {{- with .Values.rucio.server.extraVolumes }}
      {{- toYaml . | nindent 6 }}
      {{- end }}

      containers:
      - name: rucio-server
        image: {{ .Values.rucio.server.image }}
        ports:
          - containerPort: 80
        volumeMounts:
          - name: grid-certificates
            mountPath: /etc/grid-security
            readOnly: true
          {{- with .Values.rucio.server.extraVolumeMounts }}
          {{- toYaml . | nindent 10 }}
          {{- end }}

        env:
          - name: RUCIO_CFG_DATABASE_DEFAULT
            value: "postgresql://{{ .Values.postgres.auth.username }}:{{ .Values.postgres.auth.password }}@{{ .Values.rucio.server.db_host }}/{{ .Values.postgres.auth.database }}"
          - name: RUCIO_CFG_FTS3_DEFAULT
            value: "{{ .Values.rucio.server.fts_host }}"
          - name: X509_USER_CERT
            value: "{{ .Values.rucio.server.x509_cert }}"
          - name: X509_USER_KEY
            value: "{{ .Values.rucio.server.x509_key }}"
          - name: X509_CERT_DIR
            value: "/etc/ca-certs"
---
# ===================================================================
#  Rucio Client Deployment
# ===================================================================
{{- if .Values.client.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rucio-client
spec:
  replicas: {{ .Values.client.replicas }}
  selector:
    matchLabels:
      app: rucio-client
  template:
    metadata:
      labels:
        app: rucio-client
    spec:
      volumes:
      # This volume mounts the /etc/grid-security directory from the host node,
      # assuming your user certificates and CA's are present there.
      - name: grid-certificates
        hostPath:
          path: /etc/grid-security
      - name: rucio-config-volume
        configMap:
          name: rucio-client-config
      {{- with .Values.client.extraVolumes }}
      {{- toYaml . | nindent 6 }}
      {{- end }}

      containers:
        - name: rucio-client
          image: "{{ .Values.client.image.repository }}:{{ .Values.client.image.tag }}"
          imagePullPolicy: {{ .Values.client.image.pullPolicy | default "IfNotPresent" }}
          command: ["tail", "-f", "/dev/null"]
          volumeMounts:
            - name: grid-certificates
              mountPath: /etc/grid-security
              readOnly: true
            # Mount the rucio.cfg file from our ConfigMap to the correct location
            - name: rucio-config-volume
              mountPath: /opt/rucio/etc/rucio.cfg
              subPath: rucio.cfg
            {{- with .Values.client.extraVolumeMounts }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
{{- end }}