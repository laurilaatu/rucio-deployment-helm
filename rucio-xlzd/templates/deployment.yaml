apiVersion: apps/v1
kind: Deployment
metadata:
  name: rucio-server
spec:
  replicas: {{ .Values.rucio.server.replicas }}
  selector:
    matchLabels:
      app: rucio-server
  template:
    metadata:
      labels:
        app: rucio-server
    spec:
      volumes:
        - name: rucio-config-volume
          configMap:
            name: rucio-config
        {{- with .Values.rucio.server.extraVolumes }}
        {{- toYaml . | nindent 8 }}
        {{- end }}

      containers:
        - name: rucio-server
          image: {{ .Values.rucio.server.image }}
          # The container starts as root, so this hook will run as root
          ports:
            - name: http
              containerPort: 80
              protocol: TCP
            - name: https
              containerPort: 443
              protocol: TCP
              
  # --- This hook will now log to a file and not crash the pod ---
          lifecycle:
            postStart:
              exec:
                command: ["/bin/sh", "-c"]
                args:
                  - |
                    # This wraps the entire script.
                    # All output (stdout & stderr) is redirected to the log file.
                    # '|| true' ensures the hook exits 0 even if the script fails.
                    {
                      set -ex
                      echo "--- [postStart Hook] Running as $(whoami) at $(date) ---"
                      
                      echo "[postStart Hook] 1. Downloading EGI repo file..."
                      curl -o /etc/yum.repos.d/egi-trustanchors.repo https://repository.egi.eu/sw/production/cas/1/current/repo-files/egi-trustanchors.repo
                      
                      echo "[postStart Hook] 2. Installing ca-policy-egi-core..."
                      dnf install -y ca-policy-egi-core
                      
                      echo "[postStart Hook] 3. Installing gfal2-plugin-xrootd..."
                      dnf install -y gfal2-plugin-xrootd

                      echo "[postStart Hook] 4. Clean up dnf..."
                      dnf clean all
                      
                      echo "--- [postStart Hook] Package installation script finished ---"
                    } > /var/log/poststart-hook.log 2>&1 || true
          # --- End of hook ---

          {{- with .Values.rucio.server.readinessProbe }}
          readinessProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.rucio.server.livenessProbe }}
          livenessProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}

          volumeMounts:
            - name: rucio-config-volume
              mountPath: /opt/rucio/etc/rucio.cfg
              subPath: rucio.cfg
            {{- with .Values.rucio.server.extraVolumeMounts }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
            
          env:
            - name: RUCIO_ENABLE_SSL
              value: "True"
            - name: RUCIO_HTTPD_GRID_SITE_ENABLED
              value: {{ .Values.rucio.server.httpd_config.grid_site_enabled | quote }}
            - name: RUCIO_HTTPD_ENCODED_SLASHES
              value: {{ .Values.rucio.server.httpd_config.encoded_slashes | quote  }}
            - name: RUCIO_HOSTNAME
              value: "{{ .Values.rucio.server.host }}"
            - name: RUCIO_CFG_DATABASE_DEFAULT
              value: "postgresql+psycopg://{{ .Values.postgresql.auth.username }}:{{ .Values.postgresql.auth.password }}@{{ .Values.rucio.server.db_host }}/{{ .Values.postgresql.auth.database }}"
            - name: X509_USER_CERT
              value: "/etc/grid-security/hostcert.pem"
            - name: X509_USER_KEY
              value: "/etc/grid-security/hostkey.pem"
            - name: X509_CERT_DIR
              value: "/etc/grid-security/certificates"
            - name: RUCIO_HTTPD_MAX_REQUEST_WORKERS
              value: {{ .Values.rucio.server.workers.MaxRequestWorkers | quote }}
            - name: RUCIO_HTTPD_SERVER_LIMIT
              value: {{ .Values.rucio.server.workers.ServerLimit | quote }}
            - name: RUCIO_HTTPD_START_SERVERS
              value: {{ .Values.rucio.server.workers.StartServers | quote }}
            - name: RUCIO_HTTPD_MIN_SPARE_THREADS
              value: {{ .Values.rucio.server.workers.MinSpareThreads | quote }}
            - name: RUCIO_HTTPD_MAX_SPARE_THREADS
              value: {{ .Values.rucio.server.workers.MaxSpareThreads | quote }}
            - name: RUCIO_HTTPD_THREADS_PER_CHILD
              value: {{ .Values.rucio.server.workers.ThreadsPerChild | quote }}
            - name: RUCIO_HTTPD_MAX_CONNECTIONS_PER_CHILD
              value: {{ .Values.rucio.server.workers.MaxConnectionsPerChild | quote }}              
---
# ===================================================================
#  Rucio Client Deployment
# ===================================================================
{{- if .Values.client.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rucio-client
spec:
  replicas: {{ .Values.client.replicas }}
  selector:
    matchLabels:
      app: rucio-client
  template:
    metadata:
      labels:
        app: rucio-client
    spec:
      volumes:
        # Volume for the rucio.cfg file from our ConfigMap
        - name: rucio-config-volume
          configMap:
            name: rucio-client-config
            defaultMode: 0755
        # This is the extraVolume for the CA certs
        {{- with .Values.client.extraVolumes }}
        {{- toYaml . | nindent 8 }}
        {{- end }}

      containers:
        - name: rucio-client
          image: "{{ .Values.client.image.repository }}:{{ .Values.client.image.tag }}"
          imagePullPolicy: {{ .Values.client.image.pullPolicy | default "IfNotPresent" }}
          command: ["tail", "-f", "/dev/null"]
          #command: ["/bin/sh", "/app/scripts/register-rse.sh"]
          volumeMounts:
            # Mount the rucio.cfg file
            - name: rucio-config-volume
              mountPath: /opt/rucio/etc/rucio.cfg
              subPath: rucio.cfg
            - name: rucio-config-volume
              mountPath: /app/scripts/register-rse.sh
              subPath: register-rse.sh
              readOnly: true              
            # This is the extraVolumeMount for the CA certs
            {{- with .Values.client.extraVolumeMounts }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
          lifecycle:
            postStart:
              exec:
               command: ["/bin/sh", "-c", "/app/scripts/register-rse.sh"]            

{{- end }}