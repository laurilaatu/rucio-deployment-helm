{{- if .Values.client.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: rucio-client-config
data:
  rucio.cfg: |
    [client]
    rucio_host = {{ required "rucio.server.host is required!" .Values.rucio.server.host }}
    auth_host = {{ required "rucio.server.host is required!" .Values.rucio.server.host }}
    auth_type = {{ .Values.client.config.auth_type }}
    account = {{ .Values.client.config.account }}
    username = {{ .Values.client.config.username }}
    password = {{ .Values.client.config.password }}

    ca_cert = /etc/grid-security/ca.pem
    client_cert = /opt/rucio/certs/user/usercert.pem
    client_key = /opt/rucio/certs/user/userkey.pem
    request_retries = 3
    # OIDC specific settings
    oidc_scope = openid profile storage.create:/ storage.read:/ storage.modify:/ wlcg wlcg.groups
    oidc_polling = True

    oidc_issuer = {{ .Values.oidcCredentials.adminIssuer }}
    oidc_audience ={{ .Values.oidcCredentials.adminIssuer }}
    auth_oidc_refresh_active = true
    auth_oidc_refresh_before_exp = 20

    [oidc]
    idpsecrets = /opt/rucio/etc/idpsecrets.json
    admin_issuer = {{ .Values.oidcCredentials.adminIssuer }}
    expected_audience = rucio
    expected_scope = openid profile    

  register-rse.sh: |
    #!/bin/sh
    set -e
    
    RSE_NAME="BOULBY-XROOTD"
    
    echo "RSE Registration Script: Starting..."
    
    echo "Waiting for Rucio server and init-job to complete..."
    until rucio whoami; do
      echo "Rucio not ready yet. Retrying in 10 seconds..."
      sleep 10
    done
    echo "✅ Rucio server is ready."
    
    echo "Checking if RSE '$RSE_NAME' already exists..."
    if rucio rse attribute get "$RSE_NAME" rse_type >/dev/null 2>&1; then
      echo "✅ RSE '$RSE_NAME' already exists. Ensuring configuration..."
    else
      echo "Registering new RSE: $RSE_NAME"
      rucio rse add "$RSE_NAME"
    fi

    echo "Attempting to delete old protocol (if exists)..."
    rucio rse protocol delete "$RSE_NAME" --scheme root --hostname "xlzd-data.boulby.ac.uk" --port 1094 || true

    echo "Setting RSE protocol using xrootd.Default implementation..."
    
    rucio rse protocol add "$RSE_NAME" --host "xlzd-data.boulby.ac.uk" --scheme davs \
      --port 1094 \
      --prefix "/" \
      --impl "rucio.rse.protocols.gfal.Default" \
      --domain-json '{"wan": {"read": 1, "write": 1, "delete": 1, "third_party_copy_read": 1}, "lan": {"read": 1, "write": 1, "delete": 1}}'

    echo "Setting RSE attributes for OIDC authentication..."
    
    # The xrootd.Default protocol should still read these OIDC attributes
    rucio rse attribute delete "$RSE_NAME" auth_token || true
    rucio rse attribute add "$RSE_NAME" --key "oidc_issuer" --value "https://xlzd-iam.boulby.ac.uk/"
    rucio rse attribute add "$RSE_NAME" --key "oidc_client_id_path" --value "/opt/rucio/etc/oidc/oidc_client_id"
    rucio rse attribute add "$RSE_NAME" --key "oidc_client_secret_path" --value "/opt/rucio/etc/oidc/oidc_client_secret"
    rucio rse attribute add "$RSE_NAME" --key "oidc_scope" --value "storage.read:/ storage.create:/ storage.modify:/ openid profile offline_access"
    rucio rse attribute add "$RSE_NAME" --key "oidc_audience" --value "https://xlzd-data.boulby.ac.uk"
    rucio rse attribute add "$RSE_NAME" --key "sign_url" --value "wan.read"
    rucio rse attribute add "$RSE_NAME" --key "lfn2pfn_algorithm" --value "hash"
    
    echo "Setting RSE limits..."
    rucio account limit add root --rse "$RSE_NAME" --bytes 1000000000000 # 1TB

    echo "✅ Successfully configured RSE '$RSE_NAME' for OIDC."
{{- end }}
