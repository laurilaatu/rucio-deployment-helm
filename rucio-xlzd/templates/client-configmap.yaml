{{- if .Values.client.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: rucio-client-config
data:
  rucio.cfg: |
    [client]
    rucio_host = {{ required "rucio.server.host is required!" .Values.rucio.server.host }}
    auth_host = {{ required "rucio.server.host is required!" .Values.rucio.server.host }}
    auth_type = {{ .Values.client.config.auth_type }}
    account = {{ .Values.client.config.account }}
    username = {{ .Values.client.config.username }}
    password = {{ .Values.client.config.password }}
    ca_cert = /etc/grid-security/ca.pem
    client_cert = /opt/rucio/certs/user/usercert.pem
    client_key = /opt/rucio/certs/user/userkey.pem
    request_retries = 3

  register-rse.sh: |
    #!/bin/sh
    set -e
    
    RSE_NAME="BOULBY-XROOTD"
    TOKEN_PATH="/opt/rucio/etc/rse-credentials/boulby-xrootd/xrootd_token"
    
    echo "RSE Registration Script: Starting..."
    
    echo "Waiting for Rucio server and init-job to complete..."
    until rucio whoami; do
      echo "Rucio not ready yet. Retrying in 10 seconds..."
      sleep 10
    done
    echo "✅ Rucio server is ready."
    
    echo "Checking if RSE '$RSE_NAME' already exists..."
    if rucio rse attribute get "$RSE_NAME" rse_type >/dev/null 2>&1; then
      echo "✅ RSE '$RSE_NAME' already exists. Skipping registration."
    else
      echo "Registering new RSE: $RSE_NAME"
      rucio rse add "$RSE_NAME"
    fi

    echo "Setting RSE protocol..."
    # --- FIX: RSE_NAME is now a positional argument ---
    rucio rse protocol add "$RSE_NAME" --scheme root \
      --hostname "xlzd-data.boulby.ac.uk" --port 1094 \
      --prefix "/rucio/" \
      --impl "rucio.rse.protocols.xrootd.Default" \
      --domain-json '{"wan": {"read": 1, "write": 1, "delete": 1, "third_party_copy_read": 1}, "lan": {"read": 1, "write": 1, "delete": 1}}'

    echo "Setting RSE attributes..."
    # --- FIX: RSE_NAME is now a positional argument ---
    rucio rse attribute add "$RSE_NAME" \
      --key "auth_token" \
      --value "$TOKEN_PATH"

    rucio rse attribute add "$RSE_NAME" --key "sign_url" --value "wan.read"
    rucio rse attribute add "$RSE_NAME" --key "lfn2pfn_algorithm" --value "hash"
    
    echo "Setting RSE limits..."
    # --- FIX: RSE_NAME is now a positional argument ---
    rucio account limit add root "$RSE_NAME" --bytes 1000000000000 # 1TB

    echo "✅ Successfully configured RSE '$RSE_NAME'."
{{- end }}