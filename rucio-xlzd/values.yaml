rucio:
  server:
    enabled: true
    replicas: 1
    image: "rucio/rucio-server:release-38.3.0"
    loglevel: "DEBUG"
    db_host: "rucio-release-postgresql"
    db_user: "rucio"
    db_password: "rucio"
    db_name: "rucio"
    host: "https://rucio-service"
    useSSL: true
    httpd_config:
      grid_site_enabled: "True"
      encoded_slashes: "True"
    workers:
      MaxRequestWorkers: 150
      ServerLimit: 5
      StartServers: 3
      MinSpareThreads: 25
      MaxSpareThreads: 75
      ThreadsPerChild: 25
      MaxConnectionsPerChild: 1000      
    fts_host: "https://fts3-public.cern.ch:8446"
    root_identity_dn: "CN=rucio-test-user,OU=Users,O=MyOrg,L=London,ST=London,C=GB"

    # This variable is still useful for other tools.
    ca_path: "/etc/grid-security/certificates"

    # Define the volumes needed: one for server certs, one for CA certs.
    extraVolumes:
      - name: server-certs-volume
        secret:
          secretName: rucio-server-certs
      - name: ca-certs-volume
        secret:
          secretName: rucio-ca-secret
      - name: oidc-secret-volume
        secret:
          secretName: rucio-oidc-secret
          # Set permissions to be readable by the 'apache' user
          defaultMode: 0444

    # This section now uses subPath to mount individual files exactly where Apache needs them.
    extraVolumeMounts:
      # Mounts hostcert.pem from the server secret.
      - name: server-certs-volume
        mountPath: /etc/grid-security/hostcert.pem
        subPath: hostcert.pem
        readOnly: true
      # Mounts hostkey.pem from the server secret.
      - name: server-certs-volume
        mountPath: /etc/grid-security/hostkey.pem
        subPath: hostkey.pem
        readOnly: true
      # Mounts ca.pem from the CA secret.
      - name: ca-certs-volume
        mountPath: /etc/grid-security/ca.pem
        readOnly: true
        subPath: ca.pem      
      - name: ca-certs-volume
        mountPath: /etc/grid-security/certificates
        readOnly: true
        #subPath: ca.pem
      # UPDATED: Mount idpsecrets.json specifically
      - name: oidc-secret-volume
        mountPath: /opt/rucio/etc/idpsecrets.json
        subPath: idpsecrets.json
        readOnly: true
        

    service:
      type: ClusterIP
      port: 443
      targetPort: 443
      protocol: TCP
      name: https

    resources:
      limits:
        memory: "4Gi"
        cpu: "2000m"
      requests:
        memory: "2Gi"
        cpu: "2000m"

    readinessProbe:
      tcpSocket:
        port: 443
      initialDelaySeconds: 15
      periodSeconds: 20
      timeoutSeconds: 5
      failureThreshold: 3
    livenessProbe:
      tcpSocket:
        port: 443
      initialDelaySeconds: 30
      periodSeconds: 20
      timeoutSeconds: 5
      failureThreshold: 3

# Rucio Client Configuration
client:
  enabled: true
  replicas: 1
  image:
    repository: "rucio/rucio-clients"
    tag: "release-38.3.0"
    pullPolicy: Always
  config:
    auth_type: "oidc" 
    account: "root"
    username: "testuser"
    password: "testpass"

  security:
    userSecretName: "rucio-client-x509-secret"

  extraVolumes:
    - name: client-certs-volume
      secret:
        secretName: "rucio-client-x509-secret"
        defaultMode: 0400
    - name: ca-certs-volume
      secret:
        secretName: rucio-ca-secret
    - name: oidc-secret-volume
      secret:
        secretName: rucio-oidc-secret
        # Set permissions to be readable by the 'apache' user
        defaultMode: 0444        

  extraVolumeMounts:
    - name: client-certs-volume
      mountPath: /opt/rucio/certs/user
      readOnly: true
    - name: ca-certs-volume
      mountPath: /etc/grid-security/ca.pem
      subPath: ca.pem
      readOnly: true
    # UPDATED: Mount idpsecrets.json specifically
    - name: oidc-secret-volume
      mountPath: /opt/rucio/etc/idpsecrets.json
      subPath: idpsecrets.json
      readOnly: true      

  resources:
    limits:
      memory: "4Gi"
      cpu: "2000m"
    requests:
      memory: "2Gi"
      cpu: "1000m"      

  command: ["tail", "-f", "/dev/null"]


initJob:
  enabled: true
  image: "rucio/rucio-init:release-38.3.0"

  
# Database Configuration (PostgreSQL)
postgresql:
  enabled: true
  auth:
    username: rucio
    password: rucio
    database: rucio

  image:
    repository: "postgres"
    tag: "14"
  persistence:
    enabled: false


# X.509 Authentication for User Access
security:
  x509:
    enabled: true
    ca_cert_path: "/etc/grid-security/certificates" 

# UPDATED: OIDC Configuration
oidcCredentials:
  # This key maps to 'admin_issuer' in rucio.cfg
  adminIssuer: "xlzd"
  issuerUrl: "https://xlzd-iam.boulby.ac.uk/"
  clientId: "" # Set this or use --set oidcCredentials.clientId=...
  clientSecret: "" # Set this or use --set oidcCredentials.clientSecret=...
  oidcAudience: "https://xlzd-data.boulby.ac.uk/"
  # Redirect URI must match your service DNS
  redirectUri: "https://rucio-service/auth/oidc_token"

# Rucio Daemons
daemons: 
  enabled: true
  image: "rucio/rucio-daemons:release-38.3.0"

  # CRITICAL: Added oauthManager to handle tokens
  oauthManagerCount: 1
  conveyorTransferSubmitterCount: 1
  conveyorPollerCount: 1
  conveyorFinisherCount: 1
  conveyorReceiverCount: 1
  judgeEvaluatorCount: 1

  conveyorTransferSubmitter:
    activities: "'User Subscriptions'"
    sleepTime: 5
    archiveTimeout: ""
    resources:
      limits:
        memory: "4Gi"
        cpu: "3000m"
      requests:
        memory: "200Mi"
        cpu: "700m"

  conveyorPoller:
    activities: "'User Subscriptions'"
    sleepTime: 60
    olderThan: 600
    resources:
      limits:
        memory: "4Gi"
        cpu: "3000m"
      requests:
        memory: "200Mi"
        cpu: "700m"

  conveyorFinisher:
    activities: "'User Subscriptions'"
    sleepTime: 5
    resources:
      limits:
        memory: "4Gi"
        cpu: "3000m"
      requests:
        memory: "200Mi"
        cpu: "700m"

  judgeEvaluator:
    resources:
      limits:
        memory: "4Gi"
        cpu: "3000m"
      requests:
        memory: "1Gi"
        cpu: "700m"